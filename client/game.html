<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Game</title>
    <style>
      body {
        overflow: hidden;
      }

      #canvas {
        position: absolute;
        left: 0px;
        top: 0px;
      }

      .button {
        width: 60px;
      }

      #shoot {
        position:absolute;
        left:8%;
        top:90%;
        background-color: rgb(213, 34, 34);
        border: none;
        color: white;
        padding: 8px;
      }

      #left {
        position:absolute;
        left:35%;
        top:90%;
        background-color: rgb(20, 178, 217);
        border: none;
        color: white;
        padding: 8px;
      }

      #thrust {
        position:absolute;
        left:50%;
        top:80%;
        background-color: orange;
        border: none;
        color: white;
        padding: 8px;
      }

      #right {
        position:absolute;
        left:65%;
        top:90%;
        background-color: rgb(20, 178, 217);
        border: none;
        color: white;
        padding: 8px;
      }
  

    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <!-- <button class="button" id='shoot'>Shoot</button>
    <button class="button" id='left'>Left</button>
    <button class="button" id='thrust'>Thrust</button>
    <button class="button" id='right'>Right</button> -->
</body>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js" integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI" crossorigin="anonymous"></script><script>
  const socket = io()
  
  const FPS = 60
  var scale = 1
  var canv = document.getElementById("canvas")
  var ctx = canv.getContext('2d')
  canv.width = window.innerWidth
  canv.height = window.innerHeight

  window.addEventListener("resize", function (){
    canv.width = window.innerWidth
    canv.height = window.innerHeight
  })

  document.addEventListener("keydown", keyDown)
  document.addEventListener("keyup", keyUp)
  document.addEventListener("click", shoot)

  //document.getElementById("left").onclick = function() {socket.emit('left')}
  //document.getElementById("right").onclick = function() {socket.emit('right')}
  //document.getElementById("thrust").onclick = function() {socket.emit('thrust')}
  //document.getElementById("shoot").onclick = function() {socket.emit('shoot')}

  addEventListener('wheel', (e) => {
    if (e.deltaY < 0) {
      scale +=0.1
    } else if (scale > 0.19) {
      scale -=0.1
    }
  })

  addEventListener('mousemove', (e) => {
    socket.emit('mouseMove', e.pageX, canv.width/2, e.pageY, canv.height/2)
  })

  function keyDown(e){
      switch(e.keyCode){
          case 65: 
            socket.emit('leftKeyDown')
              break
          case 87: 
            socket.emit('upKeyDown')
              break
          case 68: 
            socket.emit('rightKeyDown')
              break
          case 32:
            socket.emit('shoot')
          break
      }
  }

function shoot(e) {
  socket.emit('shoot')
}

  function keyUp(e) {
      switch(e.keyCode){
          case 65: 
            socket.emit('leftKeyUp')
              break
          case 87: 
            socket.emit('upKeyUp')
              break
          case 68: 
            socket.emit('rightKeyUp')
              break
      }
  }

  

  
    let lineX = 1
    let lineY = 1

    // Get players  
    socket.on("getState", (players, bullets) => {
        myShip = null
        for (let i=0; i<players.length; i++) {
          if (players[i].id === socket.id) {
            myShip = players[i]
            if (lineX >= 50) {
              lineX = 1*scale
            } else {
              lineX -= myShip.thrust.x*scale
            }
            if (lineY >= 50) {
              lineY = 1*scale
            } else {
              lineY -= myShip.thrust.y*scale
            }
          }
          break
        }

        // Draw Background
        ctx.fillStyle = 'black'
        ctx.fillRect(0, 0, canv.width, canv.height)

        // Draw Grid
        for (var x = lineX; x < canv.width; x += 50) {
          ctx.moveTo(x, 0)
          ctx.lineTo(x, canv.height)
        }
        
        for (var y = lineY; y < canv.height; y += 50) {
          ctx.moveTo(0, y)
          ctx.lineTo(canv.width, y)
        }
        
        ctx.strokeStyle = "#141414"
        ctx.stroke()

        // Draw Co-ordinates
        //ctx.font = "20px Arial"
        //ctx.fillStyle = "white"
        //ctx.fillText(`X: ${Math.floor(myShip.x)}`, 10, 50)
        //ctx.fillText(`Y: ${Math.floor(myShip.y)}`, 10, 80)

        
        // Draw Bullets
        for (let i=0; i<bullets.length; i++) {
          bulletx = (bullets[i].x*scale)-(myShip.x*scale)+canv.width/2
          bullety = (bullets[i].y*scale)-(myShip.y*scale)+canv.height/2
          ctx.beginPath()
          ctx.arc(bulletx, bullety, 5*scale, 0, 2 * Math.PI)
          ctx.fillStyle = 'red'
          ctx.fill()
        }
        

        // Draw Moon
        moonx = 0-(myShip.x*scale)+canv.width/2
        moony = 0-(myShip.y*scale)+canv.height/2

        ctx.beginPath()
        ctx.arc(moonx, moony, 100*scale, 0, 2 * Math.PI)
        ctx.fillStyle = 'lightgrey'
        ctx.fill()


        for (let i=0; i<players.length; i++) {
            ship = players[i]
            if (players[i].id === socket.id) {
              function drawMyShip(){
                var img = new Image()
                img.src = 'lunarlander.png'
                function drawImage2(ctx, image, x, y, w, h, degrees){
                    ctx.save();
                    ctx.translate(x+w/2, y+h/2);
                    ctx.rotate(degrees);
                    ctx.translate(-x-w/2, -y-h/2);
                    ctx.drawImage(image, x, y, w, h);
                    ctx.restore();
                }
                drawImage2(ctx, img, canv.width/2-50*scale, canv.height/2-50*scale, 100*scale, 100*scale, -ship.a+7.85)
              }
              drawMyShip()
            }
            else {
              function drawShip(){
                var img = new Image()
                img.src = 'lunarlander.png'
                function drawImage2(ctx, image, x, y, w, h, degrees){
                    ctx.save();
                    ctx.translate(x+w/2, y+h/2);
                    ctx.rotate(degrees);
                    ctx.translate(-x-w/2, -y-h/2);
                    ctx.drawImage(image, x, y, w, h);
                    ctx.restore();
                }
                drawImage2(ctx, img, (ship.x*scale)-(myShip.x*scale)+canv.width/2-50*scale, (ship.y*scale)-(myShip.y*scale)+canv.height/2-50*scale, 100*scale, 100*scale, -ship.a+7.85)
            }
            drawShip()
            }  
        }
    })
</script>

</html>